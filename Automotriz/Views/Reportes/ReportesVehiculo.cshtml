
@{
    ViewBag.Title = "ReportesVehiculo";
    Layout = "~/Views/Shared/_Layout_general.cshtml";
}


<!-- Modal -->
<div class="modal fade" id="ModalRetirarVehiculo" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Retirar Vehiculo</h4>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card" style="background-color:#EEEEEE;">
                                <div class="card-header" data-background-color="orange">
                                    <h4 class="card-title">Retiro de Vehiculo</h4>
                                    <p class="category"></p>
                                </div>
                                <div class="card-content align-center table-responsive">
                                    <input type="hidden" id="txtModalIDVehiculo" name="txtModalIDVehiculo" value="0">
                                    <input type="hidden" id="txtModalPatenteVehiculo" name="txtModalPatenteVehiculo" value="0">
                                    <div class="form-group text-center">
                                        <label class="control-label">Razon del retiro del vehiculo</label>
                                        <textarea class="form-control rounded-0" id="txtAreaRetiro" rows="10"></textarea>
                                    </div>
                                    <div class="text-center">
                                        <button type="button" onclick="retirarVehiculo()" class="btn btn-primary align-middle">Retirar Vehiculo</button>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="modal-footer">
        </div>
    </div>
</div>
<!--FIN MODAL-->
<h5 class="tituloPagina">Reportes Vehículo | Sucursal <b>@ViewBag.SUCURSAL</b></h5>

<div class="card">
    <div class="card-header card-header-icon" data-background-color="orange">
        <i Class="material-icons" >assignment_turned_in</i>
    </div>
    <div class="card-content">
        <h4 class="card-title">Módulo Reportes de Vehiculos </h4>
    </div>
    <div class="row">
        <div class="col-md-12">
            <hr />

            <div class="col-sm-12">
                <div class="card">

                    <div class="card-header" data-background-color="orange">
                        <h4 class="card-title">Vehiculos en Stock </h4>
                        <a href="javascript:TablaToExcel();"><img src="https://img.icons8.com/metro/25/000000/download.png"> Exportar Excel</a>
                    </div>
                    <div class="card-content table-responsive ">
                        <table id="TablaDatos" class="table table-striped small table-hover">
                            <thead id="listarCampos">
                                <tr>
                                    <th class="text-center">PATENTE</th>
                                    <th class="text-center">FECHA INGRESO</th>
                                    <th>MARCA</th>
                                    <th>MODELO</th>
                                    <th class="text-center">ANO</th>
                                    <th class="text-center">TRANSMISION</th>
                                    <th class="text-center">COLOR</th>
                                    <th class="text-center">COMBUSTIBLE</th>
                                    <th class="text-center">DUEÑOS</th>
                                    <th class="text-center">TIPO INGRESO</th>
                                    <th class="text-center">PRECIO DE COMPRA</th>
                                    <th class="text-center">PRECIO DE VENTA</th>
                                    <th class="text-center">SUCURSAL</th>
                                    <th class="text-center">CONDICION</th>
                                    <th class="text-center">ESTADO</th>
                                    <th class="text-center">DIAS</th>
                                    <th class="text-center">USUARIO</th>
                                    <th class="text-center">VENDER</th>
                                    <th class="text-center">RETIRAR</th>


                                </tr>
                            </thead>
                            <tbody id="listarVehiculos">
                                @foreach (var vehiculo in ViewBag.ListadoVehiculos)
                                {

                                    <tr>
                                        <td class="text-center"><a href="/MantenedorVehiculo/FormularioDetalleVehiculo?ID=@vehiculo.ID_VEHICULO">@vehiculo.PATENTE.ToUpper()</a></td>
                                        <td class="text-center">@vehiculo.FECHA_INGRESO.ToString("dd/MM/yyyy")</td>
                                        <td>@vehiculo.MARCA.ToUpper()</td>
                                        <td>@vehiculo.NOMBRE_MODELO.ToUpper()</td>
                                        <td class="text-center">@vehiculo.ANO</td>
                                        <td class="text-center">@vehiculo.NOMBRE_TRANSMISION.ToUpper()</td>
                                        <td class="text-center">@vehiculo.COLOR.ToUpper()</td>
                                        <td class="text-center">@vehiculo.COMBUSTIBLE.ToUpper()</td>
                                        <td class="text-center">@vehiculo.CANTIDAD_DUENIOS</td>
                                        <td class="text-center">@vehiculo.TIPO_INGRESO</td>
                                        <td class="text-right">@vehiculo.PRECIO_COMPRA.ToString("#,##0")</td>
                                        <td class="text-right">@vehiculo.PRECIO_VENTA.ToString("#,##0")</td>
                                        <td class="text-center">@vehiculo.SUCURSAL.ToUpper()</td>
                                        <td class="text-center">@vehiculo.ESTADO.ToUpper()</td>
                                        <td class="text-center">@vehiculo.DISPONIBILIDAD</td>
                                        <td class="text-center">@vehiculo.DIAS_STOCK</td>
                                        <td class="text-center">@vehiculo.NOMBRE_USUARIO.ToUpper()</td>
                                        @if (vehiculo.DISPONIBILIDAD != "VENDIDO")
                                        {
                                            <td class="text-center">
                                                <a href="@Url.Action("FormularioNotaVenta", "Documentos")?idVehiculo=@vehiculo.ID_VEHICULO">
                                                    <i class="material-icons iconoDinero">
                                                        attach_money
                                                    </i>
                                                </a>
                                            </td>
                                        }
                                        else
                                        {

                                            <td class="text-center">
                                                <a href="#" onclick="imprimirNotaVenta('@vehiculo.ID_VEHICULO')">
                                                    <i class="material-icons iconoDinero">
                                                        book
                                                    </i>
                                                </a>

                                            </td>
                                        }


                                        <td class="text-center">
                                            <a class="align-items-center" href="#" onclick="mostrarModal('@vehiculo.ID_VEHICULO', '@vehiculo.PATENTE.ToUpper()','@vehiculo.DISPONIBILIDAD')">
                                                <i class="material-icons iconoEliminar">
                                                    clear
                                                </i>
                                            </a>
                                        </td>


                                    </tr>


                                }
                            </tbody>
                        </table>

                        <table id="TablaAuxiliar" class="tablaInvisible">
                            <thead>
                                <tr>
                                    <th class="text-center">PATENTE</th>
                                    <th class="text-center">FECHA INGRESO</th>
                                    <th>MARCA</th>
                                    <th>MODELO</th>
                                    <th class="text-center">ANO</th>
                                    <th class="text-center">TRANSMISION</th>
                                    <th class="text-center">COLOR</th>
                                    <th class="text-center">COMBUSTIBLE</th>
                                    <th class="text-center">DUEÑOS</th>
                                    <th class="text-center">TIPO INGRESO</th>
                                    <th class="text-center">PRECIO DE COMPRA</th>
                                    <th class="text-center">SUCURSAL</th>
                                    <th class="text-center">CONDICION</th>
                                    <th class="text-center">ESTADO</th>
                                    <th class="text-center">DIAS</th>
                                    <th class="text-center">USUARIO</th>
                                    <th class="text-center">VENDER</th>
                                    <th class="text-center">RETIRAR</th>
                                </tr>
                            </thead>
                            <tbody id="listarVehiculos">
                                @foreach (var vehiculo in ViewBag.ListadoVehiculos)
                                {

                                    <tr>
                                        <td class="text-center"><a href="/MantenedorVehiculo/FormularioDetalleVehiculo?ID=@vehiculo.ID_VEHICULO">@vehiculo.PATENTE.ToUpper()</a></td>
                                        <td class="text-center">@vehiculo.FECHA_INGRESO.ToString("MM:dd:yyyy")</td>
                                        <td>@vehiculo.MARCA.ToUpper()</td>
                                        <td>@vehiculo.NOMBRE_MODELO.ToUpper()</td>
                                        <td class="text-center">@vehiculo.ANO</td>
                                        <td class="text-center">@vehiculo.NOMBRE_TRANSMISION.ToUpper()</td>
                                        <td class="text-center">@vehiculo.COLOR.ToUpper()</td>
                                        <td class="text-center">@vehiculo.COMBUSTIBLE.ToUpper()</td>
                                        <td class="text-center">@vehiculo.CANTIDAD_DUENIOS</td>
                                        <td class="text-center">@vehiculo.TIPO_INGRESO</td>
                                        <td class="text-right">@vehiculo.PRECIO_COMPRA.ToString("#,##0")</td>
                                        <td class="text-center">@vehiculo.SUCURSAL.ToUpper()</td>
                                        <td class="text-center">@vehiculo.ESTADO.ToUpper()</td>
                                        <td class="text-center">@vehiculo.DISPONIBILIDAD</td>
                                        <td class="text-center">@vehiculo.DIAS_STOCK</td>
                                        <td class="text-center">@vehiculo.NOMBRE_USUARIO.ToUpper()</td>
                                        @if (vehiculo.DISPONIBILIDAD != "VENDIDO")
                                        {
                                            <td class="text-center">
                                                <a href="@Url.Action("FormularioNotaVenta", "Documentos")?idVehiculo=@vehiculo.ID_VEHICULO">
                                                    <i class="material-icons iconoDinero">
                                                        attach_money
                                                    </i>
                                                </a>
                                            </td>
                                        }
                                        else
                                        {

                                            <td class="text-center">
                                                <a href="#" onclick="imprimirNotaVenta('@vehiculo.ID_VEHICULO')">
                                                    <i class="material-icons iconoDinero">
                                                        book
                                                    </i>
                                                </a>

                                            </td>
                                        }


                                        <td class="text-center">
                                            <a class="align-items-center" href="#" onclick="mostrarModal('@vehiculo.ID_VEHICULO', '@vehiculo.PATENTE.ToUpper()','@vehiculo.DISPONIBILIDAD')">
                                                <i class="material-icons iconoEliminar">
                                                    clear
                                                </i>
                                            </a>
                                        </td>


                                    </tr>


                                }
                            </tbody>

                        </table>


                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<input id="TxtID" type="text" class="hidden" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
<script>



    $(document).ready(function () {

        $('#TablaDatos').DataTable({
            "language": {
                "url": "../assets/js/Chile.json"
            },
            "pageLength": 100

        });

    });
    function editarVehiculo(idVehiculo) {

        location.href = '@Url.Action("Documentos","imprimirNotaVentaIdVehiculo")?idVehiculo=' + idVehiculo;

    }
    function limpiarCampos() {

        $("#CmbSucursal").val(0);
        $("#CmbEstado").val(0);
        $("#CmbTipoConsigna").val(0);
        $("#CmbUsuario").val(0);
        $("#CmbDisponibilidad").val(0);
    }


    function diasStock(fechaIngreso) {
        let today = new Date();
        let fechaInicial = fechaIngreso;
        let inicio = new Date(fechaInicial);

        let diasdif = today.getTime() - inicio.getTime();
        let contdias = Math.round(diasdif / (1000 * 60 * 60 * 24));
        return contdias;

    }

    //oculta las TH de stock y de la disponibilidad cuando el vehiculo esta retirado
    function ocultarTH() {

        $(".Dias").css('display', 'none');
        $(".Disponibilidad").css('display', 'none');
    }



//============================================================================================


    function imprimirNotaVenta(idVehiculo) {

        var html = '@Url.Action("imprimirNotaVentaIdVehiculo","Documentos")?idVehiculo=' + idVehiculo;
        //window.open(html, 'popup_window2', 'width=/700, height=600, left=0, top=0,scrollbars=1');
        var win = window.open(html, '_blank');
        win.focus();

    }


    function mostrarModal(idVehiculo, patente, disponibilidad) {

        if (disponibilidad == 'VENDIDO') {

              swal({
                title: 'Automotriz Larrain',
                text: 'No se puede retirar un vehiculo ya vendido',
                type: 'error',
                confirmButtonColor: '#FE6A00',
                confirmButtonText: 'OK',
                confirmButtonClass: 'btn btn-info'
            });
            return false;

        }

        if (disponibilidad == 'RETIRADO') {

              swal({
                title: 'Automotriz Larrain',
                text: 'No se puede retirar un vehiculo ya retirado',
                type: 'error',
                confirmButtonColor: '#FE6A00',
                confirmButtonText: 'OK',
                confirmButtonClass: 'btn btn-info'
            });
            return false;

        }

            $('#ModalRetirarVehiculo').modal();
            $('#txtModalIDVehiculo').val(idVehiculo);
            $('#txtModalPatenteVehiculo').val(patente);

    }
    function retirarVehiculo() {

        gfProceso();

        var idpatenteRetirar = $('#txtModalIDVehiculo').val();
        var patenteRetirar = $('#txtModalPatenteVehiculo').val();
        var razonDelRetiro = $('#txtAreaRetiro').val();

        if (razonDelRetiro == "" || razonDelRetiro == null) {
             swal({
                title: 'Automotriz Larrain',
                text: 'Se debe ingresar razon del retiro',
                type: 'error',
                confirmButtonColor: '#FE6A00',
                confirmButtonText: 'OK',
                confirmButtonClass: 'btn btn-info'
            });
            gfProceso();
            return false;
        }


        $.ajax({
            type: "POST",
            url: "/MantenedorVehiculo/RetirarVehiuclo",
            content: "application/json; charset=utf-8",
            dataType: "json",
            data: { IdVehiculo: idpatenteRetirar,Patente:patenteRetirar,RazonDeElimninacion: razonDelRetiro},
            success: function (response) {
                try {
                    var data = jQuery.parseJSON(JSON.stringify(response));  // AQUI SE REVISA LA RESPUESTA DEL SERVICIO


                    if (data.Respuesta == "OK") // AQUI MANEJA SI EL SERVICIO RETORNO OK O CONTROLES DE ERROR
                    {

                        swal({
                            title: 'Automotriz Larrain',
                            text: 'Se retiro el vehiculo con patente '+patenteRetirar+' satisfactoriamente' ,
                            type: 'success',
                            confirmButtonColor: '#FE6A00',
                            confirmButtonText: 'OK',
                            confirmButtonClass: 'btn btn-info',
                            allowEscapeKey: false,
                            allowOutsideClick: false
                        }).then((result) => {
                            gfProceso();
                            location.reload();
                        });
                        gfProceso();
                        return false;


                    }  // IF LA RESPUESTA DEL SERVICIO ES NOK ERROR CONTROLADO......
                    else {
                        swal({
                            title: 'Automotriz Larrain',
                            text: 'Error al retirar el vehiculo con patente ' + patenteRetirar + '',
                            type: 'error',
                            confirmButtonColor: '#FE6A00',
                            confirmButtonText: 'OK',
                            confirmButtonClass: 'btn btn-info',
                            allowEscapeKey: false,
                            allowOutsideClick: false
                        });
                        gfProceso();
                        return false;
                    }

                } catch (err) { // ACCIÓN DEL ERROR DE JAVASCRIPT

                    swal({

                        title: 'Automotriz Larrain',
                        text: 'Error al retirar el vehiculo ' + err.Detalle_Error + '',
                        type: 'error',
                        confirmButtonColor: '#FE6A00',
                        confirmButtonText: 'OK',
                        confirmButtonClass: 'btn btn-info'
                    });

                    gfProceso();
                    return false;
                }

            },
            error: function (xhr, textStatus, errorThrown) { // ACCIÓN DEL ERROR DEL SERVICIO AJAX.
                swal({

                    title: 'Automotriz Larrain',
                    text: 'Error de Conexión' + textStatus + '',
                    type: 'error',
                    confirmButtonColor: '#FE6A00',
                    confirmButtonText: 'OK',
                    confirmButtonClass: 'btn btn-info'
                });

                gfProceso();
                return false;
            }
        });

    }

    function venderVehiculo(idVehiculoRetirar,patenteRetirar,disponibilidad) {

         if (disponibilidad != 'DISPONIBLE') {

              swal({
                title: 'Automotriz Larrain',
                text: 'No se puede vender un vehiculo con estado: '+disponibilidad,
                type: 'error',
                confirmButtonColor: '#FE6A00',
                confirmButtonText: 'OK',
                confirmButtonClass: 'btn btn-info'
            });
            return false;

        }







        swal({
            title: 'Automotriz Larrain ',
            text: 'Se Vehiculo con patente <b>' + patenteRetirar + '</b> se Vendera, ¿Esta seguro de venderlo?',
            type: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#4caf50',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Confirmar',
            allowEscapeKey: true,
            allowOutsideClick: true,

        }).then(function () {
            gfProceso();
            $.ajax({
                type: "POST",
                url: "/MantenedorVehiculo/VenderVehiuclo",
                content: "application/json; charset=utf-8",
                dataType: "json",
                data: { IdVehiculo: idVehiculoRetirar, Patente: patenteRetirar },
                success: function (response) {
                    try {
                        var data = jQuery.parseJSON(JSON.stringify(response));  // AQUI SE REVISA LA RESPUESTA DEL SERVICIO


                        if (data.Respuesta == "OK") // AQUI MANEJA SI EL SERVICIO RETORNO OK O CONTROLES DE ERROR
                        {

                            swal({
                                title: 'Automotriz Larrain',
                                text: 'Se Vendio el vehiculo con patente ' + patenteRetirar + ' satisfactoriamente',
                                type: 'success',
                                confirmButtonColor: '#FE6A00',
                                confirmButtonText: 'OK',
                                confirmButtonClass: 'btn btn-info',
                                allowEscapeKey: false,
                                allowOutsideClick: false
                            }).then((result) => {
                                gfProceso();
                                location.reload();
                            });
                            gfProceso();
                            return false;


                        }  // IF LA RESPUESTA DEL SERVICIO ES NOK ERROR CONTROLADO......
                        else {
                            swal({
                                title: 'Automotriz Larrain',
                                text: 'Error al Vender el vehiculo con patente ' + patenteRetirar + '',
                                type: 'error',
                                confirmButtonColor: '#FE6A00',
                                confirmButtonText: 'OK',
                                confirmButtonClass: 'btn btn-info',
                                allowEscapeKey: false,
                                allowOutsideClick: false
                            });
                            gfProceso();
                            return false;
                        }

                    } catch (err) { // ACCIÓN DEL ERROR DE JAVASCRIPT

                        swal({
                            title: 'Automotriz Larrain',
                            text: 'Error al vender el vehiculo ' + err.Detalle_Error + '',
                            type: 'error',
                            confirmButtonColor: '#FE6A00',
                            confirmButtonText: 'OK',
                            confirmButtonClass: 'btn btn-info'
                        });
                        gfProceso();
                        return false;
                    }

                },
                error: function (xhr, textStatus, errorThrown) { // ACCIÓN DEL ERROR DEL SERVICIO AJAX.
                    swal({
                        title: 'Automotriz Larrain',
                        text: 'Error de Conexión' + textStatus + '',
                        type: 'error',
                        confirmButtonColor: '#FE6A00',
                        confirmButtonText: 'OK',
                        confirmButtonClass: 'btn btn-info'
                    });
                    gfProceso();
                    return false;
                }
            });
        });
    }


    ////+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


    function TablaToExcel() {



        $("#TablaAuxiliar").table2excel({
            exclude: ".noExl",
            name: "stockVehiculos",
            filename: "stockVehiculos.xls",
            exclude_img: true,
            exclude_links: true,
            exclude_inputs: true
        });


    }


</script>
